<!DOCTYPE html>
<html>
<head>
    <title>ЛР4 AJS</title>
</head>
<body>
    <button onclick="runCallbacks()">Коллбэки</button>
    <button onclick="runPromises()">Промисы</button>
    <button onclick="runAsyncAwait()">Async/Await</button>
    <div id="output"></div>

    <script>
        function makeRequest(url, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    callback(null, JSON.parse(xhr.responseText));
                } else {
                    callback(new Error('Ошибка запроса'), null);
                }
            };
            xhr.onerror = function() { callback(new Error('Ошибка сети'), null); };
            xhr.send();
        }

        function getPostsSortedByTitle(callback) {
            makeRequest('https://jsonplaceholder.typicode.com/posts', function(error, posts) {
                if (error) return callback(error);
                const sorted = posts.sort((a, b) => b.title.length - a.title.length);
                callback(null, sorted);
            });
        }

        function getCommentsSortedByName(callback) {
            makeRequest('https://jsonplaceholder.typicode.com/comments', function(error, comments) {
                if (error) return callback(error);
                const sorted = comments.sort((a, b) => a.name.localeCompare(b.name));
                callback(null, sorted);
            });
        }

        function getUsersFiltered() {
            return fetch('https://jsonplaceholder.typicode.com/users')
                .then(response => response.json())
                .then(users => users.map(user => ({
                    id: user.id,
                    name: user.name,
                    username: user.username,
                    email: user.email,
                    phone: user.phone
                })));
        }

        function getTodosFiltered() {
            return fetch('https://jsonplaceholder.typicode.com/todos')
                .then(response => response.json())
                .then(todos => todos.filter(todo => !todo.completed));
        }

        async function getPostsSortedAsync() {
            const response = await fetch('https://jsonplaceholder.typicode.com/posts');
            const posts = await response.json();
            return posts.sort((a, b) => b.title.length - a.title.length);
        }

        async function getCommentsSortedAsync() {
            const response = await fetch('https://jsonplaceholder.typicode.com/comments');
            const comments = await response.json();
            return comments.sort((a, b) => a.name.localeCompare(b.name));
        }

        async function getUsersFilteredAsync() {
            const response = await fetch('https://jsonplaceholder.typicode.com/users');
            const users = await response.json();
            return users.map(user => ({
                id: user.id,
                name: user.name,
                username: user.username,
                email: user.email,
                phone: user.phone
            }));
        }

        async function getTodosFilteredAsync() {
            const response = await fetch('https://jsonplaceholder.typicode.com/todos');
            const todos = await response.json();
            return todos.filter(todo => !todo.completed);
        }

        function runCallbacks() {
            const output = document.getElementById('output');
            output.innerHTML = 'Загрузка...';

            getPostsSortedByTitle(function(error, posts) {
                if (error) {
                    output.innerHTML = 'Ошибка: ' + error;
                    return;
                }
                getCommentsSortedByName(function(error, comments) {
                    if (error) {
                        output.innerHTML = 'Ошибка: ' + error;
                        return;
                    }
                    output.innerHTML = 'Коллбэки - готово. Posts: ' + posts.length + ', Comments: ' + comments.length;
                });
            });
        }

        function runPromises() {
            const output = document.getElementById('output');
            output.innerHTML = 'Загрузка...';

            Promise.all([getUsersFiltered(), getTodosFiltered()])
                .then(([users, todos]) => {
                    output.innerHTML = 'Промисы - готово. Users: ' + users.length + ', Todos: ' + todos.length;
                })
                .catch(error => {
                    output.innerHTML = 'Ошибка: ' + error;
                });
        }

        async function runAsyncAwait() {
            const output = document.getElementById('output');
            output.innerHTML = 'Загрузка...';

            try {
                const posts = await getPostsSortedAsync();
                const comments = await getCommentsSortedAsync();
                const users = await getUsersFilteredAsync();
                const todos = await getTodosFilteredAsync();

                output.innerHTML = 'Async/Await - готово. Все операции выполнены';
            } catch (error) {
                output.innerHTML = 'Ошибка: ' + error;
            }
        }
    </script>
</body>
</html>